#!/usr/bin/env node

var fs = require('fs');
var http = require('http');
var url = require('url');
var util = require('util');
var child_process = require("child_process");

var backman = (function () {

    var Backman = function () {
        //模块地址
        this._modulePath = process.argv[1].split('\\bin\\main')[0];
        //资源地址
        this._assetsPath = this._modulePath + '\\build';
        //工作目录
        this._workPath = process.cwd();
        //项目描述
        this._package = null;
        //缓存服务器实例
        this._server = null;
        //初始化
        this.init();
    };

    Backman.prototype.init = function () {
        this._package = JSON.parse(fs.readFileSync(this._modulePath + '\\package.json'));
    };

    Backman.prototype._createDir = function (inPath) {
        if (inPath.length > 0) {
            if (!fs.existsSync(this._workPath + inPath)) {
                fs.mkdirSync(this._workPath + inPath, 0777);
                console.warn('Backman: Create ' + inPath);
            }
        }
    };

    Backman.prototype._createFile = function (inPath) {
        var encoding, content;
        if (/backman(\.min)?\.(css|js)(\.map)?$/.test(inPath)) {
            encoding = /(\.jpg|\.png)$/.test(inPath) ? 'binary' : 'utf-8';
            content = fs.readFileSync(this._assetsPath + inPath, encoding);
            fs.writeFileSync(this._workPath + inPath, content, encoding);
            console.warn('Backman: Create ' + inPath);
        } else {
            if (!fs.existsSync(this._workPath + inPath)) {
                encoding = /(\.jpg|\.png)$/.test(inPath) ? 'binary' : 'utf-8';
                content = fs.readFileSync(this._assetsPath + inPath, encoding);
                fs.writeFileSync(this._workPath + inPath, content, encoding);
                console.warn('Backman: Create ' + inPath);
            }
        }
    };

    Backman.prototype._readPath = function (fromPath) {
        if (fs.statSync(fromPath).isDirectory(fromPath)) {
            this._createDir(fromPath.split(this._assetsPath)[1]);
            var list = fs.readdirSync(fromPath);
            for (var i = 0, name; name = list[i]; i++) {
                this._readPath(fromPath + '\\' + name);
            }
        } else {
            this._createFile(fromPath.split(this._assetsPath)[1]);
        }
    };

    Backman.prototype._serverConfig = {
        //文件类型
        mimeType: {
            'txt': 'text/plain',
            'html': 'text/html',
            'css': 'text/css',
            'xml': 'application/xml',
            'json': 'application/json',
            'js': 'application/javascript',
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'gif': 'image/gif',
            'png': 'image/png',
            'svg': 'image/svg+xml',
            "swf": "application/x-shockwave-flash",
            "tiff": "image/tiff",
            "wav": "audio/x-wav",
            "wma": "audio/x-ms-wma",
            "wmv": "video/x-ms-wmv"
        },
        //404未找到页面
        page_404: function (req, res, path) {
            res.writeHead(404, {
                'Content-Type': 'text/html'
            });
            res.write('<!doctype html>\n');
            res.write('<title>404 Not Found</title>\n');
            res.write('<h1>Not Found</h1>');
            res.write(
                '<p>The requested URL ' +
                path +
                ' was not found on this server.</p>'
            );
            res.end();
        },
        //500错误页面
        page_500: function (req, res, error) {
            res.writeHead(500, {
                'Content-Type': 'text/html'
            });
            res.write('<!doctype html>\n');
            res.write('<title>Internal Server Error</title>\n');
            res.write('<h1>Internal Server Error</h1>');
            res.write('<pre>' + util.inspect(error) + '</pre>');
        }
    };

    //浏览当前文档
    Backman.prototype._browser = function () {
        //解析地址
        var host = 'http://localhost:8090/index.html';
        //呼起默认浏览器打开页面
        var cmd;
        //windows
        if (process.platform == 'win32') {
            cmd = 'start';
        }
        //linux
        else if (process.platform == 'linux') {
            cmd = 'xdg-open';
        }
        //mac
        else if (process.platform == 'darwin') {
            cmd = 'open';
        }
        child_process.exec(cmd + ' ' + host);
    };

    //初始化框架
    Backman.prototype.createFramework = function () {
        if (fs.readdirSync(this._workPath).length > 0) {
            console.warn('Backman: This folder is not empty, backman can\'t create project here!');
        } else {
            this._readPath(this._assetsPath);
        }
    };

    //升级框架
    Backman.prototype.updateFramework = function () {
        if (fs.readdirSync(this._workPath).length == 0) {
            console.warn('Backman: This folder is empty! You may need to use \'backman init\'.');
        } else {
            this._readPath(this._assetsPath + '/backman');
            this._readPath(this._assetsPath + '/libs');
        }
    };

    //创建框架
    Backman.prototype.createServer = function () {
        if (this._server) {
            return;
        }
        var that = this;
        this._server = http.createServer(function (req, res) {
            var pathname = url.parse(req.url).pathname;
            //真实地址
            var realPath = that._workPath + pathname;
            //解析文件
            fs.exists(realPath, function (exists) {
                if (!exists) {
                    return that._serverConfig.page_404(req, res, pathname);
                } else {
                    var file = fs.createReadStream(realPath);
                    res.writeHead(200, {
                        'Content-Type': that._serverConfig.mimeType[realPath.split('.').pop()] || 'text/plain'
                    });
                    file.on('data', res.write.bind(res));
                    file.on('close', res.end.bind(res));
                    file.on('error', function (err) {
                        return that._serverConfig.page_500(req, res, err);
                    });
                }
            });
        }).listen(8090);
        console.info('Backman: Server running at http://localhost:8090/');
        this._browser();
    };

    Backman.prototype.showVersion = function () {
        console.info('Backman: v' + this._package.version);
    };

    return new Backman();

})();

//执行命令
var command = process.argv[2];
if (command == 'init') {
    backman.createFramework();
} else if (command == 'update') {
    backman.updateFramework();
} else if (command == 'run') {
    backman.createServer();
} else if (command == '-v' || command == 'version') {
    backman.showVersion();
}